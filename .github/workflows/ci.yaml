name: CI checks

on:
  pull_request:
  push:
    branches:
      - main

jobs:
  download-srs:
    runs-on: ubuntu-latest
    outputs:
      srs-cache-hit: ${{ steps.cache-srs.outputs.cache-hit }}
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      - name: Restore SRS from cache
        id: restore-srs
        uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684
        with:
          path: circuits/examples/assets/bls_filecoin_2p19
          key: fixed-srs-cache

      - name: Download SRS if not cached
        if: steps.restore-srs.outputs.cache-hit != 'true'
        run: |
          mkdir -p circuits/examples/assets
          curl -L -o circuits/examples/assets/bls_filecoin_2p19 \
            https://midnight-s3-fileshare-dev-eu-west-1.s3.eu-west-1.amazonaws.com/bls_filecoin_2p19

  test-blstrs:
    if: github.event.pull_request.draft == false
    name: Test blstrs
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
      - uses: ./.github/actions/cargo-test
        with:
          package: midnight-curves
          args: --release --all-features

  test-circuits:
    needs: download-srs
    if: github.event.pull_request.draft == false
    name: Test circuits
    runs-on: ubuntu-latest-16-core-x64

    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
      - name: Restore SRS from cache
        uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684
        with:
          path: circuits/examples/assets/bls_filecoin_2p19
          key: fixed-srs-cache

      - uses: ./.github/actions/cargo-test
        with:
          package: midnight-circuits
          args: --release --all-features

  test-vk-consistency:
    needs: download-srs
    if: github.event.pull_request.draft == false
    name: Test VK consistency
    runs-on: ubuntu-latest-16-core-x64

    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
      - name: Restore SRS from cache
        uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684
        with:
          path: circuits/examples/assets/bls_filecoin_2p19
          key: fixed-srs-cache

      - uses: ./.github/actions/cargo-test
        with:
          package: midnight-circuits
          args: --release --all-features -- --ignored

  test-proofs:
    if: github.event.pull_request.draft == false
    name: Test proofs
    runs-on: ubuntu-latest
    steps:
      - name: Install libfontconfig1-dev
        if: runner.os == 'Linux'
        run: sudo apt-get update && sudo apt-get install -y libfontconfig1-dev
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
      - uses: ./.github/actions/cargo-test
        with:
          package: midnight-proofs
          args: --release --all-features

  test-aggregator:
    if: github.event.pull_request.draft == false
    name: Test Aggregator
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
      - uses: ./.github/actions/cargo-test
        with:
          package: midnight-aggregator
          args: --release --all-features


  doc-links:
    if: github.event.pull_request.draft == false
    name: Intra-doc links
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
      - uses: actions-rs/toolchain@b2417cde72dcf67f306c0ae8e0828a81bf0b189f
        with:
          override: false
      - name: cargo fetch
        uses: actions-rs/cargo@ae10961054e4aa8b4aa7dffede299aaf087aa33b
        with:
          command: fetch

      # Ensure intra-documentation links all resolve correctly
      # Requires #![deny(intra_doc_link_resolution_failure)] in crates.
      - name: Check intra-doc links
        uses: actions-rs/cargo@ae10961054e4aa8b4aa7dffede299aaf087aa33b
        with:
          command: doc
          args: --workspace --document-private-items --no-deps

  fmt:
    if: github.event.pull_request.draft == false
    name: Rustfmt
    timeout-minutes: 30
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
      - uses: actions-rs/toolchain@b2417cde72dcf67f306c0ae8e0828a81bf0b189f
        with:
          toolchain: nightly
          override: false
      - run: rustup component add rustfmt --toolchain nightly
      - uses: actions-rs/cargo@ae10961054e4aa8b4aa7dffede299aaf087aa33b
        with:
          toolchain: nightly
          command: fmt
          args: --all -- --check

  clippy:
    if: github.event.pull_request.draft == false
    name: Clippy
    timeout-minutes: 30
    runs-on: ubuntu-latest
    continue-on-error: true

    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
      - uses: actions-rs/toolchain@b2417cde72dcf67f306c0ae8e0828a81bf0b189f
        with:
          components: clippy
          override: false

      - name: Run Clippy on `blstrs`
        uses: actions-rs/clippy-check@b5b5f21f4797c02da247df37026fcd0a5024aa4d
        continue-on-error: true
        with:
          args: -p blstrs --all-targets --all-features -- -Dwarnings

      - name: Run Clippy on `proofs`
        uses: actions-rs/clippy-check@b5b5f21f4797c02da247df37026fcd0a5024aa4d
        continue-on-error: true
        with:
          args: -p midnight_proofs --all-targets --all-features -- -Dwarnings


      - name: Run Clippy on `circuits`
        uses: actions-rs/clippy-check@b5b5f21f4797c02da247df37026fcd0a5024aa4d
        continue-on-error: true
        with:
          args: -p midnight-circuits --all-targets --all-features -- -Dwarnings


      - name: Run Clippy on `aggregator`
        uses: actions-rs/clippy-check@b5b5f21f4797c02da247df37026fcd0a5024aa4d
        continue-on-error: true
        with:
          args: -p midnight-aggregator --all-targets --all-features -- -Dwarnings
